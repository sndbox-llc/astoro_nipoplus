---

import { LinkButton } from '@astrojs/starlight/components'

const { filename, alice = "default", msg = "", marginLess = "false" } = Astro.props;

/**
 * すべてのコンテンツ用画像を取得
 * コンテンツディレクトリ内の画像をすべて対象にします
 */
const allImages = import.meta.glob<{ default: ImageMetadata }>('/src/content/docs/**/*.{png,jpg,jpeg,webp}', { eager: true });

// すべての画像パス（キー）の配列
const imagePaths = Object.keys(allImages);

/**
 * 適切な画像を探す関数
 * 1. filename_tablet.png そのまま
 * 2. /img/filename_tablet.png (imgフォルダ内)
 * 3. 末尾が一致するもの (相対パス解決の代用)
 */
const findImage = (suffix: string) => {
  const target = `${filename}${suffix}.png`.replace('./', '');
  // パスの末尾が一致するものを探す
  const path = imagePaths.find(p => p.endsWith(target));
  return path ? allImages[path].default : null;
};

const imgTablet = findImage('_tablet');
const imgPhone = findImage('_phone');

// デバッグ用（画像が出ない時はコメントを外すとターミナルに候補が出ます）
// if(!imgTablet) console.log("Searching for:", filename, "Available:", imagePaths.slice(0,5));

const uniqueID = `character-container-${filename.replace(/\//g, '-').replace('./', '')}`;
const containerClass = marginLess === "true" ? "uTabletContainer mb-2" : "uTabletContainer mb-2 mt-5";
---

<div class={containerClass}>
  <div class="uedaTabletFrame">
    <picture class="uedaTabletPicture">
      {imgPhone && <source srcset={imgPhone.src} media="(max-width: 768px)" />}
      {imgTablet && <source srcset={imgTablet.src} media="(min-width: 769px)" />}
      {imgTablet ? (
        <img src={imgTablet.src} alt={msg} class="uedaTabletPicture" loading="lazy" width={imgTablet.width} height={imgTablet.height} />
      ) : (
        <p style="color:red; background: #fee; padding: 10px; border: 1px solid red;">
          画像が見つかりません: {filename}_tablet.png
        </p>
      )}
    </picture>
  </div>

  {msg && (
    <div class="uedaCharactorContainer" id={uniqueID}>
      <div class="ueda_character">
        {/* Aliceのパスもsrc配下にあるなら修正 */}
        <img src={`/src/images/alice/${alice}.png`} alt="キャラクター" loading="lazy" width="120" height="120" />
      </div>
      <div class="ueda_speech-bubble">
        {msg}
        <button class="btn btn-warning btn-sm close-btn" onclick={`document.getElementById('${uniqueID}').style.display='none'`}>✗</button>
      </div>
    </div>
  )}

  <div >

  <LinkButton href={`#${uniqueID}_phone`} variant="secondary" icon="external">
    スマホの画面
  </LinkButton>
  <LinkButton href={`#${uniqueID}_pc`} variant="secondary" icon="magnifier">
    PCの画面
  </LinkButton>
  </div>
</div>

{/* ライトボックス部分 */}
<div id={`${uniqueID}_pc`} class="lightbox-target">
  <a href="javascript:history.back();" class="lightbox-close">
    {imgTablet && <img src={imgTablet.src} alt={msg} class="lightbox-image" />}
  </a>
</div>

<div id={`${uniqueID}_phone`} class="lightbox-target">
  <a href="javascript:history.back();" class="lightbox-close">
    {imgPhone && <img src={imgPhone.src} alt={msg} class="lightbox-image" />}
  </a>
</div>

<div id={`${uniqueID}_pc_zoom`} class="lightbox-target">
  <a href="javascript:history.back();" class="lightbox-close">
    {imgTablet && <img src={imgTablet.src} alt={msg} class="lightbox-image" />}
  </a>
</div>

<style>
  /* 既存のスタイル */
  .lightbox-target {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 100000000;
    justify-content: center;
    align-items: center;
  }
  .lightbox-target:target {
    display: flex;
  }
  .lightbox-image {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
  }
</style>